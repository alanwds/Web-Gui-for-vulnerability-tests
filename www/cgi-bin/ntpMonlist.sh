#!/bin/bash
#Script para testar se o host esta vulneravel a ntp readvar mode 6
#O script recebe como parametro um IP de um servidor NTP a ser testado com o montlist mode 7 e retorna 0 para servidor OK, 1 para servidor vulneravel. Tambem pode retornar alguma mensagem, caso necessario 
#ATENCAO, o retorno da flag deve ser procedido de uma outra flag para separar o resultado da mensagem que o script retorna. Exemplo: 0&message, 1&anotherMessage etc..

#Autor: alanwds@gmail.com


#Recebe o IP como parametro
ip=$1;

#Testa para verificar se houve passagem correta dos parametros
if [ $# -eq 0 ]
  then
    echo "Erro: e necessario pelo menos um parametro"
    exit 1;
fi

#Monta o comando de teste
command="/usr/bin/ntpdc -n -c monlist $ip";

#Executa o test e armazena o retorno na variavel resultado. A instrucao  2>&1 e para pegar tambem o stderr caso exista
resultado=`$command  2>&1`

#Testa para verificar se esta vulneravel ou nao. Se estiver, ira retorna 1, se estiver ok ira retornar 0 + mensagem se houver. 
#Como o retorno do do servidor vulneravel sao ips validos, iremos testar se existe algum ipv4 valido no retorno da consulta 
if [[ $resultado =~ [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]
    then
	echo "1&$resultado";
else
	echo "0&$resultado";
fi
